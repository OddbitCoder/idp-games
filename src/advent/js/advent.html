<html>
	<head>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css"/>
	</head>
	<body>
		<script>
			function rmvLeadingCr(text) {
				while (text.length > 0 && text.charCodeAt(0) === 13) {
					text = text.slice(1);
				}
				return text;
			}

			var cmdQueue = [];
			var i = 0;

			// terminal

			var term = $("body").terminal(function(command) {
				if (command !== "") {
					try {
						cmdQueue.push(command);
					} catch(e) {
						this.error(new String(e));
					}
				} 
			}, {
				greetings: ""
			});
			
			// emscripten conio

			var Module = {
				cmdAvailable: function() {
					// This is called from C (waiting for input before fgets).
					return cmdQueue.length > 0;
				},
				print: function(text) {
					// This is called only on every '\n'. For 'advent', this is not a problem. '\n' is not included at the end of 'text', but 'echo' will add it.
					term.echo(rmvLeadingCr(text));
				},
				printErr: function(text) {
					term.error(rmvLeadingCr(text));
				},
				preRun: function() {
					function stdin() { 
						if (cmdQueue.length > 0 && i < cmdQueue[0].length) {
							return cmdQueue[0].charCodeAt(i++);
						} else {
							i = 0;
							if (cmdQueue.length > 0) {
								cmdQueue.shift();
								return 10; // '\n'
							} else {
								return null;
							}
						}
					}
					FS.init(stdin, /*stdout*/undefined, /*stderr*/undefined);
				}
			};
		</script>
		<script src="advent.js"></script>
	</body>
</html>
